{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/confessions.css">
<h2 style="margin-bottom:30px;">All Confessions</h2>
<!-- Filter UI removed -->
<div class="confessions-container" style="width:100%;max-width:100vw;box-sizing:border-box;">
    {% for confession in confessions %}
            <div class="confession-card">
                <div class="confession-header">
                    <div class="confession-meta">
                        <span class="username">{{ confession.username }}
                            {% set is_self = user_name == confession.username %}
                            {% set follow_state = None %}
                            {% if not is_self %}
                                {% set follow_state = None %}
                                {% for f in follows %}
                                    {% if f.follower == user_name and f.followed == confession.username %}
                                        {% if f.accepted %}
                                            {% set follow_state = 'accepted' %}
                                        {% else %}
                                            {% set follow_state = 'pending' %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if follow_state == 'accepted' %}
                                    <form action="{{ url_for('start_dm', anon_username=confession.username) }}" method="post" style="display:inline; margin-left:8px;">
                                        <button type="submit" class="message-btn" title="Send anonymous message">üí¨ Message</button>
                                    </form>
                                {% elif follow_state == 'pending' %}
                                    <button class="follow-btn" style="margin-left:8px;" disabled>‚è≥ Pending</button>
                                {% else %}
                                    <form action="{{ url_for('follow_user', anon_username=confession.username) }}" method="post" style="display:inline; margin-left:8px;">
                                        <button type="submit" class="follow-btn" title="Send follow request">‚ûï Follow</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </span>
                        <span class="time">{{ confession.time_posted | default('Unknown') }}</span>
                    </div>
                </div>
                <div class="confession-content">
                    <div><b>Title:</b> {{ confession.title }}</div>
                    <div><b>Description:</b> {{ confession.description }}</div>
                    <div><b>Main Content:</b> {{ confession.text }}</div>
                </div>
                <div class="confession-actions">
                    <form action="{{ url_for('like_confession', post_id=confession.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="like-btn">üëç Like ({{ confession.likes }})</button>
                    </form>
                    <form action="{{ url_for('heart_confession', post_id=confession.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="heart-btn">‚ù§Ô∏è Heart ({{ confession.hearts }})</button>
                    </form>
                </div>
                <div class="comments-section">
                    <strong>Comments:</strong>
                    <div class="comments-list">
        {% set comment_count = confession.comments|length %}
        {% for comment in confession.comments[:3] %}
            <div class="comment" id="comment-{{ confession.id }}-{{ loop.index0 }}">
                <span class="comment-username" style="font-weight:bold;">{{ comment.username }}</span>
                <span class="comment-time" style="font-weight:bold;">{{ comment.time_posted }}</span>
                <div class="comment-text">{{ comment.text }}</div>
            </div>
        {% endfor %}
                    </div>
    {% if comment_count > 3 %}
        <button class="see-more-btn" id="show-comments-btn-{{ confession.id }}" onclick="document.getElementById('extra-comments-{{ confession.id }}').style.display='block'; this.style.display='none';">Show Comments ({{ comment_count - 3 }})</button>
        <div class="extra-comments" id="extra-comments-{{ confession.id }}" style="display:none;">
            {% for comment in confession.comments[3:] %}
                <div class="comment" id="comment-{{ confession.id }}-{{ loop.index0 + 3 }}">
                    <span class="comment-username" style="font-weight:bold;">{{ comment.username }}</span>
                    <span class="comment-time" style="font-weight:bold;">{{ comment.time_posted }}</span>
                    <div class="comment-text">{{ comment.text }}</div>
                </div>
            {% endfor %}
            <button class="hide-comment-btn" id="hide-comments-btn-{{ confession.id }}" style="margin-top:12px;" onclick="document.getElementById('extra-comments-{{ confession.id }}').style.display='none'; document.getElementById('show-comments-btn-{{ confession.id }}').style.display='inline-block'; return false;">Hide Comments</button>
        </div>
    {% endif %}
                    <form action="{{ url_for('add_comment', post_id=confession.id) }}" method="post" class="comment-form">
                        <input type="text" name="comment" placeholder="Add a comment..." required>
                        <button type="submit">Comment</button>
                    </form>
                    <script>
                        function hideComment(confessionId, commentIdx) {
                            var commentDiv = document.getElementById('comment-' + confessionId + '-' + commentIdx);
                            if (commentDiv) {
                                commentDiv.style.display = 'none';
                            }
                        }
                    </script>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
