{% extends "base.html" %}
{% block content %}
    <h2>All Confessions</h2>
    {% for confession in confessions|reverse %}
        <div class="confession">
            <div class="username"><b>{{ confession.username }}</b></div>
            <div><b>Title:</b> {{ confession.title|e }}</div>
            <div><b>Description:</b> {{ confession.description|e }}</div>
            <div><b>Main Content:</b><br>
                <div style="margin-left:10px;">{{ confession.text|e }}</div>
            </div>
            {% if confession.files and confession.files|length > 0 %}
                <div>Files:
                    <ul>
                    {% for file in confession.files %}
                        <li><a class="file-link" href="{{ url_for('uploaded_file', filename=file) }}" target="_blank">{{ file }}</a></li>
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}
            <div>Likes: {{ confession.likes or 0 }}
                <form method="POST" action="{{ url_for('like_confession', post_id=confession.id) }}" style="display:inline;">
                    <button class="like-btn" type="submit">üëç Like</button>
                </form>
            </div>
            <div>Hearts: {{ confession.hearts or 0 }}
                <form method="POST" action="{{ url_for('heart_confession', post_id=confession.id) }}" style="display:inline;">
                    <button class="heart-btn" type="submit">‚ù§Ô∏è Heart</button>
                </form>
            </div>
            <div>Comments:</div>
            {% if confession.comments %}
                {% for comment in confession.comments %}
                    <div class="comment">- <b>{{ comment.username }}</b>: {{ comment.text|e }}
                        <span style="margin-left:10px;">
                            Likes: {{ comment.likes or 0 }}
                            <form method="POST" action="{{ url_for('like_comment', post_id=confession.id, comment_idx=loop.index0) }}" style="display:inline;">
                                <button type="submit" class="like-btn">üëç</button>
                            </form>
                            Hearts: {{ comment.hearts or 0 }}
                            <form method="POST" action="{{ url_for('heart_comment', post_id=confession.id, comment_idx=loop.index0) }}" style="display:inline;">
                                <button type="submit" class="heart-btn">‚ù§Ô∏è</button>
                            </form>
                        </span>
                    </div>
                    {% if comment.replies %}
                        <div style="margin-left:30px;">
                        {% for reply in comment.replies %}
                            <div class="comment" style="color:#007bff;">‚Ü≥ <b>{{ reply.username }}</b>: {{ reply.text|e }}
                                <span style="margin-left:10px;">
                                    Likes: {{ reply.likes or 0 }}
                                    <form method="POST" action="{{ url_for('like_reply', post_id=confession.id, comment_idx=loop.parent.index0, reply_idx=loop.index0) }}" style="display:inline;">
                                        <button type="submit" class="like-btn">üëç</button>
                                    </form>
                                    Hearts: {{ reply.hearts or 0 }}
                                    <form method="POST" action="{{ url_for('heart_reply', post_id=confession.id, comment_idx=loop.parent.index0, reply_idx=loop.index0) }}" style="display:inline;">
                                        <button type="submit" class="heart-btn">‚ù§Ô∏è</button>
                                    </form>
                                </span>
                            </div>
                        {% endfor %}
                        </div>
                    {% endif %}
                    <!-- Reply form removed: reply_comment endpoint does not exist -->
                        <input type="text" name="reply" placeholder="Reply to this comment..." required style="width:65%;display:inline-block;">
                        <button type="submit">Reply</button>
                    </form>
                {% endfor %}
            {% else %}
                <div class="comment">No comments yet.</div>
            {% endif %}
            <form class="comment-form" method="POST" action="{{ url_for('add_comment', post_id=confession.id) }}">
                <input type="text" name="comment" placeholder="Add a comment..." required>
                <button type="submit">Comment</button>
            </form>
        </div>
    {% else %}
        <p>No confessions yet.</p>
    {% endfor %}
{% endblock %}
